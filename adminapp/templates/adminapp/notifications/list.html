{% extends 'adminapp/base.html' %}

{% block title %}Notifications - MedAdmin{% endblock %}
{% block page_title %}System Notifications{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header with Actions -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-semibold text-gray-800">All Notifications</h2>
                <p class="text-gray-600 mt-1">System alerts and activity notifications</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="markAllRead()"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-check-double"></i>
                    <span>Mark All Read</span>
                </button>
                <button onclick="clearAllNotifications()"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-trash"></i>
                    <span>Clear All</span>
                </button>
            </div>
        </div>

        <!-- Notification Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-600">{{ notifications.count }}</div>
                <div class="text-blue-700 text-sm">Total</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-red-600">
                    {{ notifications|length|add:"-read_count" }}
                </div>
                <div class="text-red-700 text-sm">Unread</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-600">
                    {{ read_count }}
                </div>
                <div class="text-green-700 text-sm">Read</div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-purple-600">
                    {{ today_count }}
                </div>
                <div class="text-purple-700 text-sm">Today</div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="filterNotifications('all')"
                class="filter-tab flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 active-tab">
                All Notifications
            </button>
            <button onclick="filterNotifications('unread')"
                class="filter-tab flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200">
                Unread Only
            </button>
            <button onclick="filterNotifications('today')"
                class="filter-tab flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200">
                Today
            </button>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        {% if notifications %}
        <div class="divide-y divide-gray-200" id="notifications-list">
            {% for notification in notifications %}
            <div class="notification-item p-6 hover:bg-gray-50 transition-colors duration-200 {% if not notification.is_read %}bg-blue-50 border-l-4 border-blue-500{% endif %}"
                data-type="{{ notification.notification_type }}"
                data-read="{{ notification.is_read|yesno:'true,false' }}"
                data-date="{{ notification.created_at|date:'Y-m-d' }}">
                <div class="flex items-start space-x-4">
                    <!-- Notification Icon -->
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center 
                            {% if notification.notification_type == 'user_registration' %}bg-green-100 text-green-600
                            {% elif notification.notification_type == 'doctor_registration' %}bg-blue-100 text-blue-600
                            {% elif notification.notification_type == 'hospital_registration' %}bg-purple-100 text-purple-600
                            {% elif notification.notification_type == 'new_appointment' %}bg-orange-100 text-orange-600
                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                            {% if notification.notification_type == 'user_registration' %}
                            <i class="fas fa-user-plus text-lg"></i>
                            {% elif notification.notification_type == 'doctor_registration' %}
                            <i class="fas fa-user-md text-lg"></i>
                            {% elif notification.notification_type == 'hospital_registration' %}
                            <i class="fas fa-hospital text-lg"></i>
                            {% elif notification.notification_type == 'new_appointment' %}
                            <i class="fas fa-calendar-check text-lg"></i>
                            {% else %}
                            <i class="fas fa-bell text-lg"></i>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Notification Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">
                                    {{ notification.title }}
                                </h3>
                                <p class="text-gray-600 mb-2">{{ notification.message }}</p>

                                <!-- Related Entity Information -->
                                <div class="flex flex-wrap gap-2 mt-3">
                                    {% if notification.related_user %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-user mr-1"></i>
                                        User: {{ notification.related_user.fullname }}
                                    </span>
                                    {% endif %}

                                    {% if notification.related_doctor %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-user-md mr-1"></i>
                                        Doctor: Dr. {{ notification.related_doctor.name }}
                                    </span>
                                    {% endif %}

                                    {% if notification.related_hospital %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        <i class="fas fa-hospital mr-1"></i>
                                        Hospital: {{ notification.related_hospital.name }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center space-x-2">
                                {% if not notification.is_read %}
                                <button onclick="markNotificationRead('{{ notification.id }}')"
                                    class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition-colors duration-200"
                                    title="Mark as read">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}

                                <button onclick="deleteNotification('{{ notification.id }}')"
                                    class="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors duration-200"
                                    title="Delete notification">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>

                            <!-- Metadata -->
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span class="flex items-center space-x-1">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ notification.created_at|timesince }} ago</span>
                                    </span>
                                    <span class="flex items-center space-x-1">
                                        <i class="fas fa-calendar"></i>
                                        <span>{{ notification.created_at|date:"M d, Y H:i" }}</span>
                                    </span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if notification.notification_type == 'user_registration' %}bg-green-100 text-green-800
                                    {% elif notification.notification_type == 'doctor_registration' %}bg-blue-100 text-blue-800
                                    {% elif notification.notification_type == 'hospital_registration' %}bg-purple-100 text-purple-800
                                    {% elif notification.notification_type == 'new_appointment' %}bg-orange-100 text-orange-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ notification.get_notification_type_display }}
                                    </span>
                                </div>

                                {% if not notification.is_read %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-circle mr-1"></i>
                                    Unread
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-check mr-1"></i>
                                    Read
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Empty State -->
            {% else %}
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-bell-slash text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">No notifications</h3>
                <p class="text-gray-600 mb-6">You're all caught up! There are no notifications to display.</p>
                <button onclick="location.reload()"
                    class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Pagination -->
        {% if notifications.has_other_pages %}
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing {{ notifications.start_index }} to {{ notifications.end_index }} of {{
                    notifications.paginator.count }} notifications
                </div>
                <div class="flex space-x-2">
                    {% if notifications.has_previous %}
                    <a href="?page=1"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ notifications.previous_page_number }}"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-angle-left"></i>
                    </a>
                    {% endif %}

                    {% for num in notifications.paginator.page_range %}
                    {% if notifications.number == num %}
                    <span class="px-3 py-2 bg-blue-500 text-white rounded-lg">{{ num }}</span>
                    {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %} <a
                        href="?page={{ num }}"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        {{ num }}
                        </a>
                        {% endif %}
                        {% endfor %}

                        {% if notifications.has_next %}
                        <a href="?page={{ notifications.next_page_number }}"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?page={{ notifications.paginator.num_pages }}"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                        {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="modalTitle">Confirm Action</h3>
                <p class="text-gray-600 mb-6" id="modalMessage">Are you sure you want to perform this action?</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeModal()"
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button onclick="confirmAction()"
                        class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200"
                        id="confirmButton">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .filter-tab {
            background: transparent;
            color: #6b7280;
        }

        .filter-tab:hover {
            background: white;
            color: #374151;
        }

        .active-tab {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .notification-item {
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
    </style>

    <script>
        let currentAction = '';
        let currentNotificationId = null;

        // Filter notifications
        function filterNotifications(filter) {
            const notifications = document.querySelectorAll('.notification-item');
            const today = new Date().toISOString().split('T')[0];

            notifications.forEach(notification => {
                const isRead = notification.getAttribute('data-read') === 'true';
                const notificationDate = notification.getAttribute('data-date');

                let show = true;

                switch (filter) {
                    case 'unread':
                        show = !isRead;
                        break;
                    case 'today':
                        show = notificationDate === today;
                        break;
                    case 'all':
                    default:
                        show = true;
                }

                notification.style.display = show ? 'block' : 'none';
            });

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active-tab');
            });
            event.target.classList.add('active-tab');
        }

        // Mark notification as read
        function markNotificationRead(notificationId) {
            fetch(`/admin-dashboard/notifications/mark-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI
                        const notification = document.querySelector(`[onclick="markNotificationRead(${notificationId})"]`).closest('.notification-item');
                        notification.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');

                        // Update read status badge
                        const badge = notification.querySelector('.bg-blue-100');
                        if (badge) {
                            badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                            badge.innerHTML = '<i class="fas fa-check mr-1"></i>Read';
                        }

                        // Remove mark as read button
                        const markReadBtn = notification.querySelector('[onclick^="markNotificationRead"]');
                        if (markReadBtn) {
                            markReadBtn.remove();
                        }

                        // Update counters
                        updateNotificationCounters();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error marking notification as read');
                });
        }

        // Mark all notifications as read
        function markAllRead() {
            showModal(
                'Mark All as Read',
                'Are you sure you want to mark all notifications as read?',
                'Mark All Read',
                function () {
                    fetch('/admin-dashboard/notifications/mark-all-read/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update all notifications in UI
                                document.querySelectorAll('.notification-item').forEach(notification => {
                                    notification.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');

                                    const badge = notification.querySelector('.bg-blue-100');
                                    if (badge) {
                                        badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                                        badge.innerHTML = '<i class="fas fa-check mr-1"></i>Read';
                                    }

                                    const markReadBtn = notification.querySelector('[onclick^="markNotificationRead"]');
                                    if (markReadBtn) {
                                        markReadBtn.remove();
                                    }
                                });

                                updateNotificationCounters();
                                closeModal();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error marking all notifications as read');
                        });
                }
            );
        }

        // Delete notification
        function deleteNotification(notificationId) {
            currentNotificationId = notificationId;
            showModal(
                'Delete Notification',
                'Are you sure you want to delete this notification? This action cannot be undone.',
                'Delete',
                function () {
                    fetch(`/admin-dashboard/notifications/delete/${notificationId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove notification from UI
                                const notification = document.querySelector(`[onclick="deleteNotification(${notificationId})"]`).closest('.notification-item');
                                notification.style.opacity = '0';
                                setTimeout(() => {
                                    notification.remove();
                                    updateNotificationCounters();

                                    // Check if no notifications left
                                    if (document.querySelectorAll('.notification-item').length === 0) {
                                        location.reload();
                                    }
                                }, 300);

                                closeModal();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error deleting notification');
                        });
                }
            );
        }

        // Clear all notifications
        function clearAllNotifications() {
            showModal(
                'Clear All Notifications',
                'Are you sure you want to delete all notifications? This action cannot be undone.',
                'Clear All',
                function () {
                    fetch('/admin-dashboard/notifications/clear-all/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error clearing all notifications');
                        });
                }
            );
        }

        // Modal functions
        function showModal(title, message, buttonText, confirmCallback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmButton').textContent = buttonText;
            currentAction = confirmCallback;
            document.getElementById('confirmationModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
            currentAction = '';
            currentNotificationId = null;
        }

        function confirmAction() {
            if (currentAction) {
                currentAction();
            }
        }

        // Update notification counters
        function updateNotificationCounters() {
            // This would typically make an API call to get updated counts
            // For now, we'll just reload the page to get fresh data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Close modal on background click
        document.getElementById('confirmationModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Any initialization code
        });
    </script>
    {% endblock %}