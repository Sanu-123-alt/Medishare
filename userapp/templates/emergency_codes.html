<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Access QR Code</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Emergency Access QR Code</h4>
                </div>
                <div class="card-body text-center">
                    <div id="qrCodeContainer">
                        {% if error %}
                            <div class="alert alert-danger">
                                {{ error }}
                            </div>
                        {% elif qr_code %}
                            <div class="mb-4">
                                <img src="data:image/png;base64,{{ qr_code }}" alt="Emergency Access QR Code" class="img-fluid" style="max-width: 300px;">
                            </div>
                            <div class="mb-3">
                                <h5>Access Code:</h5>
                                <p class="lead">{{ access_code }}</p>
                            </div>
                            <div class="mb-3">
                                <h5>Expires At:</h5>
                                <p>{{ expires_at }}</p>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="refreshQRCode()">
                                    <i class="fas fa-sync"></i> Refresh QR Code
                                </button>
                            </div>
                        {% else %}
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Generating QR Code...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function refreshQRCode() {
    const container = document.getElementById('qrCodeContainer');
    container.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Refreshing QR Code...</p>
        </div>
    `;
    
    loadQRCode();
}

function loadQRCode() {
    const csrftoken = getCookie('csrftoken');
    const container = document.getElementById('qrCodeContainer');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Generating QR Code...</p>
        </div>
    `;
    
    fetch('/emergency/codes/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!response.ok) {
            throw new Error(response.statusText || 'Network response was not ok');
        }
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
        }
        return response.text();
    })
    .then(html => {
        if (html.trim().startsWith('{')) {
            // Response is JSON
            const data = JSON.parse(html);
            if (data.error) {
                throw new Error(data.error);
            }
        }
        container.innerHTML = html;
    })
    .catch(error => {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-circle"></i> Error Generating QR Code</h5>
                <p>${error.message}</p>
                <button class="btn btn-outline-primary mt-3" onclick="refreshQRCode()">
                    <i class="fas fa-sync"></i> Try Again
                </button>
            </div>
        `;
    });
}

// Load QR code when the page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!document.querySelector('#qrCodeContainer img')) {
        loadQRCode();
    }
});
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<script>
async function testApi() {
    const messageArea = document.getElementById("messageArea");
    const form = document.getElementById("emergency-form");
    const csrfToken = form.querySelector("input[name=csrfmiddlewaretoken]").value;

    try {
        const response = await fetch("/emergency/generate-qr/", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest",
                "Accept": "application/json"
            }
        });

        const data = await response.json();
        messageArea.innerHTML = `
            <div class="alert alert-info">
                Response: ${JSON.stringify(data)}
            </div>
        `;
    } catch (error) {
        messageArea.innerHTML = `
            <div class="alert alert-danger">
                Error: ${error.message}
            </div>
        `;
        console.error("API Error:", error);
    }
}
</script>
{% endblock %}
